
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VLA äº¤é€šæ¢çº½ä»¿çœŸ - è‡ªå®šä¹‰åŒºåŸŸ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #map { height: 500px; }
        .card { margin-bottom: 15px; }
        .region-btn { margin: 2px; }
        .custom-coords { background: #f8f9fa; padding: 10px; border-radius: 5px; }
        .simulation-loading {
            display: none;
            text-align: center;
            padding: 10px;
        }
        .spinner-border {
            width: 1.5rem;
            height: 1.5rem;
        }
        .hub-marker {
            background-color: rgba(255, 0, 0, 0.7);
            border-radius: 50%;
            width: 15px;
            height: 15px;
            border: 2px solid white;
        }
        .demand-marker {
            background-color: rgba(0, 0, 255, 0.5);
            border-radius: 50%;
            width: 8px;
            height: 8px;
            border: 1px solid white;
        }
        .selected-hub {
            background-color: rgba(255, 215, 0, 0.8);
            border: 2px solid #ff9900;
        }
        .legend {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-3">
        <h2>ğŸ—ºï¸ è‡ªå®šä¹‰åŒºåŸŸäº¤é€šæ¢çº½ä»¿çœŸ</h2>

        <div class="row">
            <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="card-title mb-0">ğŸ“ é€‰æ‹©ä»¿çœŸåŒºåŸŸ</h5>
                    </div>
                    <div class="card-body">
                        <!-- é¢„è®¾åŸå¸‚ -->
                        <div class="mb-3">
                            <label class="form-label">ğŸ™ï¸ é¢„è®¾åŸå¸‚</label>
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-primary region-btn" onclick="selectRegion('beijing')">
                                    åŒ—äº¬å—ç«™
                                </button>
                                <button class="btn btn-outline-primary region-btn" onclick="selectRegion('shanghai')">
                                    ä¸Šæµ·è™¹æ¡¥
                                </button>
                                <button class="btn btn-outline-primary region-btn" onclick="selectRegion('guangzhou')">
                                    å¹¿å·å—ç«™
                                </button>
                                <button class="btn btn-outline-primary region-btn" onclick="selectRegion('shenzhen')">
                                    æ·±åœ³åŒ—ç«™
                                </button>
                            </div>
                        </div>

                        <!-- è‡ªå®šä¹‰åæ ‡ -->
                        <div class="mb-3">
                            <label class="form-label">ğŸ¯ è‡ªå®šä¹‰åæ ‡</label>
                            <div class="custom-coords">
                                <div class="row">
                                    <div class="col-6">
                                        <label class="form-label small">ç»åº¦</label>
                                        <input type="number" class="form-control form-control-sm" id="customLng"
                                               step="0.0001" placeholder="116.378558" value="116.378558">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small">çº¬åº¦</label>
                                        <input type="number" class="form-control form-control-sm" id="customLat"
                                               step="0.0001" placeholder="39.864444" value="39.864444">
                                    </div>
                                </div>
                                <button class="btn btn-success btn-sm w-100 mt-2" onclick="useCustomCoords()">
                                    ä½¿ç”¨è‡ªå®šä¹‰åæ ‡
                                </button>
                            </div>
                        </div>

                        <!-- åœ°å›¾é€‰ç‚¹ -->
                        <div class="mb-3">
                            <label class="form-label">ğŸ—ºï¸ åœ°å›¾é€‰ç‚¹</label>
                            <div class="alert alert-info small">
                                ğŸ’¡ ç›´æ¥åœ¨åœ°å›¾ä¸Šç‚¹å‡»é€‰æ‹©ä¸­å¿ƒç‚¹ä½ç½®
                            </div>
                        </div>

                        <!-- ä»¿çœŸå‚æ•° -->
                        <div class="mb-3">
                            <label class="form-label">âš™ï¸ ä»¿çœŸå‚æ•°</label>
                            <div class="row">
                                <div class="col-6">
                                    <label class="form-label small">éœ€æ±‚ç‚¹æ•°é‡</label>
                                    <input type="number" class="form-control form-control-sm" id="nDemand"
                                           value="150" min="10" max="500">
                                </div>
                                <div class="col-6">
                                    <label class="form-label small">å€™é€‰æ¢çº½æ•°</label>
                                    <input type="number" class="form-control form-control-sm" id="nHubs"
                                           value="12" min="3" max="50">
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-12">
                                    <label class="form-label small">ä»¿çœŸåŠå¾„ (å…¬é‡Œ)</label>
                                    <input type="range" class="form-range" id="simulationRadius"
                                           min="1" max="10" step="0.5" value="2">
                                    <div class="d-flex justify-content-between">
                                        <small>1km</small>
                                        <small id="radiusValue">2km</small>
                                        <small>10km</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button class="btn btn-primary w-100" onclick="runSimulation()">
                            ğŸš€ å¼€å§‹åŒºåŸŸä»¿çœŸ
                        </button>

                        <div class="simulation-loading mt-2" id="simulationLoading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">åŠ è½½ä¸­...</span>
                            </div>
                            <p class="mt-2">ä»¿çœŸè®¡ç®—ä¸­...</p>
                        </div>
                    </div>
                </div>

                <!-- ç»“æœæ˜¾ç¤º -->
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="card-title mb-0">ğŸ“Š ä»¿çœŸç»“æœ</h5>
                    </div>
                    <div class="card-body">
                        <div id="results">
                            <p class="text-muted text-center">è¯·å…ˆé€‰æ‹©åŒºåŸŸ...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§åœ°å›¾ -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">ä»¿çœŸåœ°å›¾</h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="toggleLegend()">
                            å›¾ä¾‹
                        </button>
                    </div>
                    <div class="card-body p-0 position-relative">
                        <div id="map"></div>
                        <div id="legend" class="legend position-absolute bottom-0 end-0 m-3" style="display: none;">
                            <h6>å›¾ä¾‹</h6>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: blue;"></div>
                                <small>ä¸­å¿ƒç‚¹</small>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: rgba(255, 0, 0, 0.7);"></div>
                                <small>å€™é€‰æ¢çº½</small>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: rgba(0, 0, 255, 0.5);"></div>
                                <small>éœ€æ±‚ç‚¹</small>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: rgba(255, 215, 0, 0.8);"></div>
                                <small>æœ€ä¼˜æ¢çº½</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // é¢„è®¾åŸå¸‚åæ ‡
        const regions = {
            'beijing': { name: 'åŒ—äº¬å—ç«™', lat: 39.864444, lng: 116.378558 },
            'shanghai': { name: 'ä¸Šæµ·è™¹æ¡¥', lat: 31.193687, lng: 121.318542 },
            'guangzhou': { name: 'å¹¿å·å—ç«™', lat: 22.989383, lng: 113.270707 },
            'shenzhen': { name: 'æ·±åœ³åŒ—ç«™', lat: 22.611362, lng: 114.029531 }
        };

        // å…¨å±€å˜é‡
        let map, currentCenter, markers = [];
        let simulationData = { hubs: [], demands: [] };

        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            // é»˜è®¤æ˜¾ç¤ºåŒ—äº¬
            currentCenter = [regions.beijing.lat, regions.beijing.lng];

            map = L.map('map').setView(currentCenter, 14);

            // æ·»åŠ OSMåº•å›¾
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(map);

            // æ·»åŠ ç‚¹å‡»é€‰ç‚¹åŠŸèƒ½
            map.on('click', function(e) {
                selectPoint(e.latlng.lat, e.latlng.lng);
            });

            // åˆå§‹æ ‡è®°
            addCenterMarker(currentCenter[0], currentCenter[1], 'åŒ—äº¬å—ç«™');

            // åˆå§‹åŒ–åŠå¾„æ»‘å—æ˜¾ç¤º
            document.getElementById('radiusValue').textContent =
                document.getElementById('simulationRadius').value + 'km';

            // ç›‘å¬åŠå¾„å˜åŒ–
            document.getElementById('simulationRadius').addEventListener('input', function() {
                document.getElementById('radiusValue').textContent = this.value + 'km';
                if (currentCenter) {
                    updateCenterCircle();
                }
            });
        }

        // é€‰æ‹©é¢„è®¾åŒºåŸŸ
        function selectRegion(regionKey) {
            const region = regions[regionKey];
            if (region) {
                currentCenter = [region.lat, region.lng];
                map.setView(currentCenter, 14);
                addCenterMarker(region.lat, region.lng, region.name);
                updateResults(`å·²é€‰æ‹©: ${region.name}`);

                // æ›´æ–°è‡ªå®šä¹‰åæ ‡è¾“å…¥æ¡†
                document.getElementById('customLat').value = region.lat;
                document.getElementById('customLng').value = region.lng;
            }
        }

        // ä½¿ç”¨è‡ªå®šä¹‰åæ ‡
        function useCustomCoords() {
            const lat = parseFloat(document.getElementById('customLat').value);
            const lng = parseFloat(document.getElementById('customLng').value);

            if (!isNaN(lat) && !isNaN(lng)) {
                if (lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
                    currentCenter = [lat, lng];
                    map.setView(currentCenter, 14);
                    addCenterMarker(lat, lng, 'è‡ªå®šä¹‰ä½ç½®');
                    updateResults(`å·²é€‰æ‹©è‡ªå®šä¹‰ä½ç½®: ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
                } else {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ç»çº¬åº¦åæ ‡ï¼çº¬åº¦èŒƒå›´ï¼š-90~90ï¼Œç»åº¦èŒƒå›´ï¼š-180~180');
                }
            } else {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ç»çº¬åº¦åæ ‡ï¼');
            }
        }

        // åœ°å›¾ç‚¹å‡»é€‰ç‚¹
        function selectPoint(lat, lng) {
            currentCenter = [lat, lng];
            addCenterMarker(lat, lng, 'é€‰ä¸­ä½ç½®');
            updateResults(`åœ°å›¾é€‰ç‚¹: ${lat.toFixed(6)}, ${lng.toFixed(6)}`);

            // æ›´æ–°è‡ªå®šä¹‰åæ ‡è¾“å…¥æ¡†
            document.getElementById('customLat').value = lat.toFixed(6);
            document.getElementById('customLng').value = lng.toFixed(6);
        }

        // æ·»åŠ ä¸­å¿ƒç‚¹æ ‡è®°
        function addCenterMarker(lat, lng, title) {
            // æ¸…é™¤æ—§æ ‡è®°
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            // æ·»åŠ æ–°æ ‡è®°
            const marker = L.marker([lat, lng])
                .addTo(map)
                .bindPopup(`<b>${title}</b><br>çº¬åº¦: ${lat.toFixed(6)}<br>ç»åº¦: ${lng.toFixed(6)}`)
                .openPopup();

            markers.push(marker);

            // æ›´æ–°èŒƒå›´åœˆ
            updateCenterCircle();
        }

        // æ›´æ–°ä¸­å¿ƒç‚¹èŒƒå›´åœˆ
        function updateCenterCircle() {
            const radius = parseFloat(document.getElementById('simulationRadius').value) * 1000; // è½¬æ¢ä¸ºç±³

            // æ·»åŠ èŒƒå›´åœˆ
            const circle = L.circle(currentCenter, {
                color: 'blue',
                fillColor: '#30f',
                fillOpacity: 0.1,
                radius: radius
            }).addTo(map);

            markers.push(circle);
        }

        // è¿è¡Œä»¿çœŸ
        function runSimulation() {
            if (!currentCenter) {
                alert('è¯·å…ˆé€‰æ‹©åŒºåŸŸï¼');
                return;
            }

            const nDemand = parseInt(document.getElementById('nDemand').value) || 150;
            const nHubs = parseInt(document.getElementById('nHubs').value) || 12;
            const radius = parseFloat(document.getElementById('simulationRadius').value);

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('simulationLoading').style.display = 'block';

            updateResults(`
                <div class="alert alert-info">
                    <strong>ğŸš€ å¼€å§‹åŒºåŸŸä»¿çœŸ</strong><br>
                    ğŸ“ ä¸­å¿ƒä½ç½®: ${currentCenter[0].toFixed(6)}, ${currentCenter[1].toFixed(6)}<br>
                    ğŸ“Š éœ€æ±‚ç‚¹: ${nDemand} ä¸ª<br>
                    ğŸ¢ å€™é€‰æ¢çº½: ${nHubs} ä¸ª<br>
                    ğŸ“ ä»¿çœŸåŠå¾„: ${radius} å…¬é‡Œ
                </div>
            `);

            // ä½¿ç”¨setTimeoutæ¨¡æ‹Ÿè®¡ç®—å»¶è¿Ÿ
            setTimeout(() => {
                // ç”Ÿæˆå€™é€‰æ¢çº½
                const hubs = generateHubsAround(currentCenter, nHubs, radius);

                // ç”Ÿæˆéœ€æ±‚ç‚¹
                const demands = generateDemandPoints(currentCenter, nDemand, radius);

                // ä¿å­˜ä»¿çœŸæ•°æ®
                simulationData = { hubs, demands };

                // åœ¨åœ°å›¾ä¸Šæ˜¾ç¤º
                displaySimulationResults(hubs, demands);

                // éšè—åŠ è½½çŠ¶æ€
                document.getElementById('simulationLoading').style.display = 'none';
            }, 1000);
        }

        // ç”Ÿæˆå€™é€‰æ¢çº½
        function generateHubsAround(center, count, radiusKm) {
            const hubs = [];
            const radiusDeg = radiusKm / 111; // ç²—ç•¥è½¬æ¢ï¼š1åº¦çº¬åº¦çº¦111å…¬é‡Œ

            for (let i = 0; i < count; i++) {
                // ä½¿ç”¨æåæ ‡æ–¹æ³•ç”Ÿæˆæ›´å‡åŒ€çš„åˆ†å¸ƒ
                const angle = Math.random() * 2 * Math.PI;
                const distance = Math.random() * radiusDeg * 0.8; // 80%çš„åŠå¾„èŒƒå›´å†…

                hubs.push({
                    lat: center[0] + distance * Math.sin(angle),
                    lng: center[1] + distance * Math.cos(angle),
                    id: i,
                    capacity: Math.floor(Math.random() * 1000) + 500 // éšæœºå®¹é‡
                });
            }
            return hubs;
        }

        // ç”Ÿæˆéœ€æ±‚ç‚¹
        function generateDemandPoints(center, count, radiusKm) {
            const points = [];
            const radiusDeg = radiusKm / 111; // ç²—ç•¥è½¬æ¢ï¼š1åº¦çº¬åº¦çº¦111å…¬é‡Œ

            for (let i = 0; i < count; i++) {
                // ä½¿ç”¨æåæ ‡æ–¹æ³•ç”Ÿæˆæ›´å‡åŒ€çš„åˆ†å¸ƒ
                const angle = Math.random() * 2 * Math.PI;
                const distance = Math.random() * radiusDeg;

                points.push({
                    lat: center[0] + distance * Math.sin(angle),
                    lng: center[1] + distance * Math.cos(angle),
                    demand: Math.floor(Math.random() * 100) + 10 // éšæœºéœ€æ±‚
                });
            }
            return points;
        }

        // æ˜¾ç¤ºä»¿çœŸç»“æœ
        function displaySimulationResults(hubs, demands) {
            // æ¸…é™¤æ—§çš„å¯è§†åŒ–
            markers.forEach(marker => {
                if (marker instanceof L.Circle || marker instanceof L.CircleMarker) {
                    map.removeLayer(marker);
                }
            });

            // æ˜¾ç¤ºéœ€æ±‚ç‚¹
            demands.forEach(point => {
                const marker = L.circleMarker([point.lat, point.lng], {
                    color: 'blue',
                    fillColor: '#30f',
                    fillOpacity: 0.6,
                    radius: 4
                }).addTo(map);
                markers.push(marker);
            });

            // æ˜¾ç¤ºå€™é€‰æ¢çº½
            hubs.forEach((hub, index) => {
                const isOptimal = index < 3; // ç®€å•æ¨¡æ‹Ÿï¼šå‰3ä¸ªä¸ºæœ€ä¼˜æ¢çº½

                const marker = L.circleMarker([hub.lat, hub.lng], {
                    color: isOptimal ? '#ff9900' : 'red',
                    fillColor: isOptimal ? 'rgba(255, 215, 0, 0.8)' : 'rgba(255, 0, 0, 0.7)',
                    fillOpacity: 0.8,
                    radius: 8
                }).addTo(map).bindPopup(`
                    <b>${isOptimal ? 'â˜… æœ€ä¼˜æ¢çº½' : 'å€™é€‰æ¢çº½'} ${index + 1}</b><br>
                    å®¹é‡: ${hub.capacity}<br>
                    ä½ç½®: ${hub.lat.toFixed(6)}, ${hub.lng.toFixed(6)}
                `);

                if (isOptimal) {
                    marker.setStyle({ className: 'selected-hub' });
                }

                markers.push(marker);
            });

            // è®¡ç®—ä¸€äº›ç»Ÿè®¡ä¿¡æ¯
            const totalDemand = demands.reduce((sum, point) => sum + point.demand, 0);
            const totalCapacity = hubs.reduce((sum, hub) => sum + hub.capacity, 0);
            const coverageRatio = (totalDemand / totalCapacity * 100).toFixed(1);

            updateResults(`
                <div class="alert alert-success">
                    <strong>âœ… ä»¿çœŸå®Œæˆ</strong><br>
                    ğŸ¢ ç”Ÿæˆå€™é€‰æ¢çº½: ${hubs.length} ä¸ª<br>
                    ğŸ“ ç”Ÿæˆéœ€æ±‚ç‚¹: ${demands.length} ä¸ª<br>
                    ğŸ“Š æ€»éœ€æ±‚: ${totalDemand} å•ä½<br>
                    ğŸ—ï¸ æ€»å®¹é‡: ${totalCapacity} å•ä½<br>
                    ğŸ“ˆ è¦†ç›–ç‡: ${coverageRatio}%<br>
                    ğŸ—ºï¸ æŸ¥çœ‹åœ°å›¾ä¸Šçš„å¯è§†åŒ–ç»“æœ
                </div>
                <button class="btn btn-sm btn-outline-info w-100 mt-2" onclick="exportData()">
                    å¯¼å‡ºä»¿çœŸæ•°æ®
                </button>
            `);
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            const dataStr = JSON.stringify(simulationData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});

            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = 'simulation_data.json';
            link.click();
        }

        // åˆ‡æ¢å›¾ä¾‹æ˜¾ç¤º
        function toggleLegend() {
            const legend = document.getElementById('legend');
            legend.style.display = legend.style.display === 'none' ? 'block' : 'none';
        }

        // æ›´æ–°ç»“æœæ˜¾ç¤º
        function updateResults(html) {
            document.getElementById('results').innerHTML = html;
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>
</html>
